name: Deploy Plugin

on:
  push:
    branches:
      - main # Or your default branch
  workflow_dispatch: # Allows manual triggering

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1' # Or your required PHP version
          extensions: imap, zip # Make sure imap is included
          tools: composer

      - name: Install Composer Dependencies
        run: composer install --no-dev --optimize-autoloader

      - name: Zip Plugin
        run: |
          zip -r fast-imap.zip fast-imap/ -x "fast-imap/.git/*" "fast-imap/vendor/*" "fast-imap/.github/*"

      - name: Release to GitHub Releases
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/') # Only run on tags
        with:
          files: fast-imap.zip
          generate_release_notes: true

      - name: Deploy to Server via SSH
        if: github.ref == 'refs/heads/main' # Only deploy from main branch
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          script: |
            cd /path/to/your/wordpress/wp-content/plugins/ #change this to your correct plugin path
            rm -rf fast-imap
            unzip /tmp/fast-imap.zip -d /tmp/
            mv /tmp/fast-imap/* .
            rm /tmp/fast-imap.zip
            # add any other commands to run after deploy, such as wp-cli commands.
            wp plugin activate fast-imap #If you want to activate on deployment.
